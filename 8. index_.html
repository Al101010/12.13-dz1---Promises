<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>12.13-8</title>
    <!-- <script src="slow.js"></script> -->
</head>
<body>
    <h1>12.13-8.Promise - async, async/await</h1>
    
    <script>

function json(data) {
    return new Promise((resolve, reject) => {
        // эмуляция обработки ArrayBuffer
        setTimeout(() => {
            resolve(String.fromCharCode.apply(null, new Uint16Array(data)));
        }, 500);
    });
}

function read() {
    return new Promise((resolve, reject) => {
        // эмуляция чтения файла
        setTimeout(() => {
            const data = '{"id":9,"created":1546300800,"userInfo":{"id":1,"name":"Hitman","level":10,"points":2000}}';
            return (input => {
                const buffer = new ArrayBuffer(input.length * 2);
                const bufferView = new Uint16Array(buffer);
                for (let i = 0; i < input.length; i++) {
                    bufferView[i] = input.charCodeAt(i);
                }
                resolve(buffer);
            })(data);
        }, 1000); 
    });
}

class GameSaving {
  constructor(id = null, created = null, userInfo = {}) {
    this.id = id;
    this.created = created;
    this.userInfo = userInfo;
  }
}

class GameSavingLoader {
  static load() {
    return read()
      .then((data) => json(data))
      .then((value) => JSON.parse(value))
      .then(({ id, created, userInfo }) => new GameSaving(id, created, userInfo));
  }
}

// const result = await GameSavingLoader.load();
// const result = async () => { return await GameSavingLoader.load();}
// const result_ = result();
// console.log(result_);

// const result = new Promise(function(resolve, reject) {
//   setTimeout(() => resolve("done!"), 1000);
// });

// ------------------------------------------------------- РАБОТАЕТ ---------------------
// let result = null;
// (async() => {
//     let result = await GameSavingLoader.load();

//     console.log(result);
// })();

// ------------------------------------------------------- РАБОТАЕТ ---------------------
// const result = () => {
//     let result = GameSavingLoader.load();
// }
function delay(ms) {return new Promise((resolve, reject) => setTimeout(resolve, ms))}

delay(1000).then(async() => {
    let result = await GameSavingLoader.load();
    return console.log(result)})


// console.log(result); // не успевает
    </script>

    </script>
</body>
</html>